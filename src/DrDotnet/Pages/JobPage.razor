@page "/job/{ProcessId}/{ProfilerId}"
@using DrDotnet.Utils;
@using Microsoft.Extensions.Logging

@inject NavigationManager _navigationManager
@inject IProfilerDiscovery _profilerDiscovery
@inject IProcessDiscovery _processDiscovery
@inject ISessionDiscovery _sessionDiscovery
@inject ILogger _logger

<MatIconButton Style="float: left;" Icon="@MatIconNames.Arrow_back" OnClick="@OnBackClick"></MatIconButton>

<h3 class="mat-h3">Job</h3>

<div class="mat-layout-grid">
    <div class="mat-layout-grid-inner mat-elevation-z5" style="padding: 20px;">
        <div class="mat-layout-grid-cell mat-layout-grid-cell-span-6">
            <h4 class="mat-h4">@_profiler.Name</h4>
        </div>
        
        <div class="mat-layout-grid-cell mat-layout-grid-cell-span-6 mat-body1">
            @_profiler.Uuid
        </div>

        <div class="mat-layout-grid-cell mat-layout-grid-cell-span-12 mat-body1">
            @_profiler.Description
        </div>
        
        @if (_profiler.Parameters.Count > 0)
        {
            <div class="mat-layout-grid-cell mat-layout-grid-cell-span-12">
                <h4 class="mat-h5">Parameters</h4>
            </div>
            
            @foreach (ProfilerParameter parameter in _profiler.Parameters)
            {
                <p>
                    <MatTooltip Tooltip="@parameter.Description">           
                        @switch (parameter.Type)
                        {
                            case ParameterType.String:
                                <MatTextField RefBack="@context" @bind-Value="@parameter.Value" Label="@parameter.Name"></MatTextField> 
                                break;
                            case ParameterType.Int:
                                <MatTextField RefBack="@context" @bind-Value="@parameter.ValueInt32" Label="@parameter.Name"></MatTextField>
                                break;
                            case ParameterType.Float:
                                <MatTextField RefBack="@context" @bind-Value="@parameter.ValueFloat32" Label="@parameter.Name"></MatTextField>
                                break;
                            case ParameterType.Boolean:
                                <MatCheckbox RefBack="@context" @bind-Value="@parameter.ValueBoolean" Label="@parameter.Name"></MatCheckbox>
                                break;
                        }       
                    </MatTooltip>
                </p>
            }
        }

        <div class="mat-layout-grid-cell mat-layout-grid-cell-span-12">
            @if (Started)
            {
                <h3 class="mat-subtitle1">Analysis in progress, please wait...</h3>
                <MatProgressBar Indeterminate="true"></MatProgressBar>
            }
            else
            {
                if (Session != null)
                {
                    <MatButton Raised="true" Icon="@MatIconNames.Play_arrow" Label="View session results" OnClick="OnViewSessionResultsClicked" Style="float: right;"></MatButton>
                }
                else
                {
                    <MatButton Raised="true" Icon="@MatIconNames.Play_arrow" Label="Attach to process" OnClick="OnRunAnalysisClicked" Style="float: right;"></MatButton>
                }
            }
        </div>
    </div>
</div>

@code {

    private bool Started { get; set; }
    private SessionInfo Session { get; set; }

    [Parameter]
    public string ProcessId { get; set; }

    [Parameter]
    public string ProfilerId { get; set; }

    public ProfilerInfo _profiler;

    protected override void OnInitialized()
    {
        base.OnInitialized();

        _profiler = _profilerDiscovery.GetProfilers().Where(x => x.Uuid == ProfilerId).First();
    }

    private async Task OnRunAnalysisClicked(object data)
    {
        Started = true;

        try
        {
            _logger.LogInformation("Start profiling!");
            var session = ProfilingExtensions.StartProfilingSession(_profiler, _processDiscovery.GetProcessInfoFromPid(int.Parse(ProcessId)), _logger);
            _logger.LogInformation("Successfully attached to process!");
            await session.AwaitUntilCompletion();
            Session = session;
        }
        catch (Exception e)
        {
            _logger.LogError(e, "Could not attach to process {ProcessId}", ProcessId);
        }

        Started = false;
    }

    public void OnViewSessionResultsClicked(object data)
    {
        _navigationManager.NavigateTo($"/sessions/{Session.SessionId}", true);
    }

    public void OnBackClick(object data)
    {
        _navigationManager.NavigateTo($"/profilers/{ProcessId}", true);
    }
} 